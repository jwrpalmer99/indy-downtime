<div class="drep-settings drep-dialog">
  <input type="hidden" name="trackerId" value="{{trackerId}}" />
  <input type="hidden" name="phaseOrder" value="{{phaseOrder}}" />
  <p class="notes">
    Edit phase structure, checks, DCs, and narratives. Changes apply when you save.
  </p>

  <nav class="drep-phase-tabs">
    {{#each phases}}
      <button type="button" class="drep-tab-button" data-tab="{{this.id}}">
        Phase {{this.number}}
      </button>
    {{/each}}
    <button type="button" class="drep-tab-button drep-add-phase" data-drep-action="add-phase">
      + Add Phase
    </button>
  </nav>

  {{#each phases}}
    <section class="drep-phase-tab" data-tab="{{this.id}}">
      <fieldset class="drep-phase-block">
        <legend>Phase {{this.number}}: {{this.name}}</legend>
        <div class="drep-phase-actions">
          <button type="button" class="dialog-button flow" data-drep-action="view-flow" data-phase-id="{{this.id}}">
            View Flow
          </button>
          {{#unless this.isPhase1}}
            <button type="button" class="dialog-button" data-drep-action="remove-phase" data-phase-id="{{this.id}}">
              Remove Phase
            </button>
          {{/unless}}
        </div>

        <div class="drep-grid">
          <label>
            Phase Name
            <input type="text" style="width: 100%" name="phases.{{this.id}}.name" value="{{this.name}}" />
          </label>
          <label>
            Phase Target
            <input type="number" style="width: 80px" name="phases.{{this.id}}.target" value="{{this.target}}" min="0" />
          </label>
        </div>

        <div class="drep-grid drep-phase-flags">
          <label class="phase-checkbox">
            <input type="checkbox" class="phase-checkbox" name="phases.{{this.id}}.allowCriticalBonus" {{#if this.allowCriticalBonus}}checked{{/if}} />
            Allow critical bonus
          </label>
          <label class="phase-checkbox">
            <input type="checkbox" class="phase-checkbox" name="phases.{{this.id}}.failureEvents" {{#if this.failureEvents}}checked{{/if}} />
            Failures trigger events
          </label>
        </div>

        <div class="drep-grid">
          <label>
            Failure Event Table (UUID)
            <input type="text" style="width: 100%"name="phases.{{this.id}}.failureEventTable" value="{{this.failureEventTable}}" data-drep-drop="rolltable" />
          </label>
          <label>
            Phase Image
            <div class="drep-image-input" style="width: 100%">
              <input type="text" name="phases.{{this.id}}.image" value="{{this.image}}" />
              <button type="button" class="file-picker" data-type="image" data-target="phases.{{this.id}}.image">
                <i class="fas fa-file-import"></i>
              </button>
            </div>
          </label>
        </div>

        <div class="drep-grid">
          <label>
            Phase Complete Message
            <textarea name="phases.{{this.id}}.phaseCompleteMessage" rows="2">{{this.phaseCompleteMessage}}</textarea>
          </label>
          <label>
            Phase Complete Macro (UUID)
            <input type="text" style="width: 100%" name="phases.{{this.id}}.phaseCompleteMacro" value="{{this.phaseCompleteMacro}}" data-drep-drop="macro" />
          </label>
        </div>

        <details class="drep-phase-section drep-collapsible" data-collapse-id="phase-{{this.id}}-groups">
          <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Groups</span><span class="drep-summary-chips">{{#each this.groups}}<span class="drep-summary-chip drep-group-chip" data-group-id="{{this.id}}" title="Drag to dependencies">{{#if this.name}}{{this.name}}{{else}}Group{{/if}}</span>{{/each}}</span></summary>
          <div class="drep-phase-section-header">
            <button type="button" class="dialog-button" data-drep-action="add-group" data-phase-id="{{this.id}}">
              Add Group
            </button>
          </div>
         
          {{#each this.groups}}
            <details class="drep-group-card drep-collapsible" data-group-id="{{this.id}}" data-collapse-id="phase-{{../id}}-group-{{this.id}}">
              <summary class="drep-group-summary"><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Group: {{#if this.name}}{{this.name}}{{else}}Group{{/if}}</span><span class="drep-summary-chips">{{#each this.checks}}<span class="drep-summary-chip drep-check-chip" data-check-id="{{this.id}}" title="Drag to dependencies">{{#if this.name}}{{this.name}}{{else}}Check{{/if}}</span>{{/each}}</span></summary>
              <div class="drep-group-header">
                <div class="drep-group-title">
                  <label>
                    Group Name
                    <input type="text" name="phases.{{../id}}.groups.{{this.id}}.name" value="{{this.name}}" />
                  </label>
                  <span class="drep-group-chip" data-group-id="{{this.id}}" title="Drag to dependencies">
                    {{#if this.name}}{{this.name}}{{else}}Group{{/if}}
                  </span>
                </div>
                <div class="drep-group-actions">
                  <button type="button" class="dialog-button" data-drep-action="add-check" data-phase-id="{{../id}}" data-group-id="{{this.id}}">
                    + Check
                  </button>
                  <button type="button" class="dialog-button" data-drep-action="remove-group" data-phase-id="{{../id}}" data-group-id="{{this.id}}">
                    Remove Group
                  </button>
                </div>
              </div>

              <details class="drep-checks-section drep-collapsible" data-collapse-id="phase-{{../../id}}-group-{{../id}}-checks">
                <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Checks</span></summary>
                <div class="drep-check-list">
                  {{#each this.checks}}
                    <div class="drep-check-card" data-check-id="{{this.id}}">
                      <div class="drep-check-fields">
                        <div class="drep-check-header-row drep-field-full">
                          <label class="drep-check-name">
                            Check Name
                            <input type="text" name="phases.{{../../id}}.groups.{{../id}}.checks.{{this.id}}.name" value="{{this.name}}" />
                          </label>
                          <button type="button" class="dialog-button drep-check-remove" data-drep-action="remove-check" data-phase-id="{{../../id}}" data-group-id="{{../id}}" data-check-id="{{this.id}}">
                            Remove Check
                          </button>
                        </div>
                        <label>
                          Skill
                          <select name="phases.{{../../id}}.groups.{{../id}}.checks.{{this.id}}.skill">
                            {{#each @root.skillOptions}}
                              <option value="{{this.key}}" {{#if (eq ../skill this.key)}}selected{{/if}}>{{this.label}}</option>
                            {{/each}}
                          </select>
                        </label>
                        <label class="drep-check-dc">
                          DC
                          <input type="number" class="drep-input-compact" name="phases.{{../../id}}.groups.{{../id}}.checks.{{this.id}}.dc" value="{{this.dc}}" min="0" />
                        </label>
                        <label class="drep-field-full">
                          Description
                          <input type="text" name="phases.{{../../id}}.groups.{{../id}}.checks.{{this.id}}.description" value="{{this.description}}" />
                        </label>
                      </div>
                      <input type="hidden" class="drep-deps-input-checks" name="phases.{{../../id}}.groups.{{../id}}.checks.{{this.id}}.dependsOn" value="{{this.dependsOnValue}}" />
                    </div>
                  {{/each}}
                  {{#unless this.checks.length}}
                    <div class="drep-muted">No checks in this group yet.</div>
                  {{/unless}}
                </div>
              </details>
            </details>
          {{/each}}
          {{#unless this.groups.length}}
            <div class="drep-muted">No check groups yet. Add one to start.</div>
          {{/unless}}
        </details>

        <details class="drep-phase-section drep-collapsible" data-collapse-id="phase-{{this.id}}-success">
          <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Success Lines</span></summary>
          <div class="drep-phase-section-header">
            <h3>Success Lines</h3>
            <button type="button" class="dialog-button" data-drep-action="add-success-line" data-phase-id="{{this.id}}">
              Add Line
            </button>
          </div>
          {{#each this.successLines}}
            <div class="drep-line-card card-success">
              <textarea name="phases.{{../id}}.successLines.{{this.id}}.text" rows="2">{{this.text}}</textarea>
              <input type="hidden" class="drep-deps-input-checks" name="phases.{{../id}}.successLines.{{this.id}}.dependsOnChecks" value="{{this.dependsOnChecksValue}}" />
              <input type="hidden" class="drep-deps-input-groups" name="phases.{{../id}}.successLines.{{this.id}}.dependsOnGroups" value="{{this.dependsOnGroupsValue}}" />
              <div class="drep-line-actions">
                <button type="button" class="dialog-button" data-drep-action="remove-line" data-phase-id="{{../id}}" data-line-type="success" data-line-id="{{this.id}}">
                  Remove
                </button>
              </div>
            </div>
          {{/each}}
          {{#unless this.successLines.length}}
            <div class="drep-muted">No success lines yet.</div>
          {{/unless}}
        </details>

        <details class="drep-phase-section drep-collapsible" data-collapse-id="phase-{{this.id}}-failure">
          <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Failure Lines</span></summary>
          <div class="drep-phase-section-header">
            <h3>Failure Lines</h3>
            <button type="button" class="dialog-button" data-drep-action="add-failure-line" data-phase-id="{{this.id}}">
              Add Line
            </button>
          </div>
          {{#each this.failureLines}}
            <div class="drep-line-card card-failure">
              <textarea name="phases.{{../id}}.failureLines.{{this.id}}.text" rows="2">{{this.text}}</textarea>
              <input type="hidden" class="drep-deps-input-checks" name="phases.{{../id}}.failureLines.{{this.id}}.dependsOnChecks" value="{{this.dependsOnChecksValue}}" />
              <input type="hidden" class="drep-deps-input-groups" name="phases.{{../id}}.failureLines.{{this.id}}.dependsOnGroups" value="{{this.dependsOnGroupsValue}}" />
              <div class="drep-line-actions">
                <button type="button" class="dialog-button" data-drep-action="remove-line" data-phase-id="{{../id}}" data-line-type="failure" data-line-id="{{this.id}}">
                  Remove
                </button>
              </div>
            </div>
          {{/each}}
          {{#unless this.failureLines.length}}
            <div class="drep-muted">No failure lines yet.</div>
          {{/unless}}
        </details>
      </fieldset>
    </section>
  {{/each}}

  <footer class="sheet-footer flexrow">
    <button type="submit" class="dialog-button">
      <i class="far fa-save"></i>
      Save
    </button>
  </footer>
</div>
