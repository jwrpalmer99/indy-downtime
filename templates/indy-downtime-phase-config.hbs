<div class="drep-settings drep-dialog">
  <input type="hidden" name="trackerId" value="{{trackerId}}" />
  <input type="hidden" name="phaseOrder" value="{{phaseOrder}}" />
  <p class="notes">
    Edit phase structure, checks, DCs, and narratives. Changes apply when you save.
  </p>


  <nav class="drep-phase-tabs">
    {{#each phases}}
      <button type="button" class="drep-tab-button" data-tab="{{this.id}}">
        Phase {{this.number}}
      </button>
    {{/each}}
    <button type="button" class="drep-tab-button drep-add-phase" data-drep-action="add-phase">
      + Add Phase
    </button>
  </nav>

  {{#each phases}}
    <section class="drep-phase-tab" data-tab="{{this.id}}">
      <fieldset class="drep-phase-block">
        <legend>Phase {{this.number}}: {{this.name}}</legend>
        <div class="drep-phase-actions">
          <button type="button" class="dialog-button flow" data-drep-action="view-flow" data-phase-id="{{this.id}}">
            Edit Flow
          </button>
          {{#unless this.isPhase1}}
            <button type="button" class="dialog-button" data-drep-action="remove-phase" data-phase-id="{{this.id}}">
              Remove Phase
            </button>
          {{/unless}}
        </div>

        <div class="drep-grid">
          <label>
            Phase Name
            <input type="text" style="width: 100%" name="phases.{{this.id}}.name" value="{{this.name}}" />
          </label>
          <label>
            Phase Target
            <input type="number" style="width: 80px" name="phases.{{this.id}}.target" value="{{this.target}}" min="0" />
          </label>
        </div>

        <div class="drep-grid drep-phase-flags">
          <label class="phase-checkbox">
            <input type="checkbox" class="phase-checkbox" name="phases.{{this.id}}.allowCriticalBonus" {{#if this.allowCriticalBonus}}checked{{/if}} />
            Allow critical bonus
          </label>
          <label class="phase-checkbox">
            <input type="checkbox" class="phase-checkbox" name="phases.{{this.id}}.failureEvents" {{#if this.failureEvents}}checked{{/if}} />
            Failures trigger events
          </label>
        </div>

        <div class="drep-grid">
          <label>
            Failure Event Table (UUID)
            <input type="text" style="width: 100%"name="phases.{{this.id}}.failureEventTable" value="{{this.failureEventTable}}" data-drep-drop="rolltable" />
          </label>
          <label>
            Phase Image
            <div class="drep-image-input" style="width: 100%">
              <input type="text" name="phases.{{this.id}}.image" value="{{this.image}}" />
              <button type="button" class="file-picker" data-type="image" data-target="phases.{{this.id}}.image">
                <i class="fas fa-file-import"></i>
              </button>
            </div>
          </label>
        </div>

        <div class="drep-grid">
          <label>
            Phase Complete Message
            <textarea name="phases.{{this.id}}.phaseCompleteMessage" rows="2">{{this.phaseCompleteMessage}}</textarea>
          </label>
          <label>
            Phase Complete Macro (UUID)
            <input type="text" style="width: 100%" name="phases.{{this.id}}.phaseCompleteMacro" value="{{this.phaseCompleteMacro}}" data-drep-drop="macro" />
          </label>
        </div>
        <div class="drep-grid">
          <label>
            Phase Complete Items (UUID)
            <div class="drep-item-drop" data-drep-drop="item" data-phase-id="{{this.id}}">
              <div class="drep-item-list">
                {{#if this.phaseCompleteItemsDisplay.length}}
                  {{#each this.phaseCompleteItemsDisplay}}
                    <div class="drep-item-row" data-item-index="{{@index}}">
                      <input type="text" class="drep-item-name" value="{{this.name}}" title="{{this.uuid}}" readonly />
                      <input type="number" class="drep-item-qty" min="1" value="{{this.qty}}" data-drep-action="phase-item-qty" data-phase-id="{{../id}}" data-item-index="{{@index}}" />
                      <button type="button" class="drep-item-remove" data-drep-action="remove-phase-item" data-phase-id="{{../id}}" data-item-index="{{@index}}">x</button>
                    </div>
                  {{/each}}
                {{else}}
                  <div class="drep-muted">Drop items here.</div>
                {{/if}}
              </div>
              <input type="hidden" name="phases.{{this.id}}.phaseCompleteItems" value='{{this.phaseCompleteItemsJson}}' />
            </div>
          </label>
        </div>

      <div class="drep-phase-import">
        <button type="button" class="dialog-button" data-drep-action="phase-import-export">
          Import/Export Phase Config
        </button>
      </div>

      </fieldset>
    </section>
  {{/each}}

  <footer class="sheet-footer flexrow">
    <button type="submit" class="dialog-button">
      <i class="far fa-save"></i>
      Save
    </button>
  </footer>
</div>
