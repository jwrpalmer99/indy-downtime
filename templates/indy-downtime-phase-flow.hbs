<section class="drep-flow">
  <header class="drep-flow-header">
    <h2>Phase {{phaseNumber}}: {{phaseName}}</h2>
  </header>

  {{#if (and (not readOnly) showFlowLines unassignedSuccess.length)}}
    <details class="drep-flow-unassigned drep-collapsible" data-collapse-id="unassigned-success">
      <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Unassigned Success Lines</span></summary>
      <div class="drep-flow-lines success">
        {{#each unassignedSuccess}}
          <div class="drep-flow-line drep-flow-line-chip" draggable="true" data-drep-line-id="{{this.id}}" data-drep-line-type="success"><span class="drep-flow-line-text drep-flow-editable" data-edit="line-text" data-line-id="{{this.id}}" data-line-type="success" data-value="{{this.text}}">{{this.text}}</span>{{#unless @root.readOnly}}<button type="button" class="drep-flow-line-remove" title="Remove">x</button>{{/unless}}</div>
        {{/each}}
      </div>
    </details>
  {{/if}}
  {{#if (and (not readOnly) showFlowLines unassignedFailure.length)}}
    <details class="drep-flow-unassigned drep-collapsible" data-collapse-id="unassigned-failure">
      <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Unassigned Failure Lines</span></summary>
      <div class="drep-flow-lines failure">
        {{#each unassignedFailure}}
          <div class="drep-flow-line drep-flow-line-chip" draggable="true" data-drep-line-id="{{this.id}}" data-drep-line-type="failure"><span class="drep-flow-line-text drep-flow-editable" data-edit="line-text" data-line-id="{{this.id}}" data-line-type="failure" data-value="{{this.text}}">{{this.text}}</span>{{#unless @root.readOnly}}<button type="button" class="drep-flow-line-remove" title="Remove">x</button>{{/unless}}</div>
        {{/each}}
      </div>
    </details>
  {{/if}}

  <div class="drep-flow-lanes">
    {{#each groups}}
      <div class="drep-flow-lane" data-drep-group-id="{{this.id}}">
        <div class="drep-flow-lane-header">{{this.name}}{{#if this.maxChecks}} <span class="drep-flow-group-cap">(Max Success: {{this.maxChecks}})</span>{{/if}}</div>
        {{#if (and @root.showFlowLines this.successLines.length)}}
          <details class="drep-flow-lines success drep-collapsible" data-collapse-id="group-{{this.id}}-success">
            <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Group Success Lines</span></summary>
            {{#each this.successLines}}
              <div class="drep-flow-line drep-flow-line-chip" draggable="true" data-drep-line-id="{{this.id}}" data-drep-line-type="success"><span class="drep-flow-line-text drep-flow-editable" data-edit="line-text" data-line-id="{{this.id}}" data-line-type="success" data-value="{{this.text}}">{{this.text}}</span>{{#unless @root.readOnly}}<button type="button" class="drep-flow-line-remove" title="Remove">x</button>{{/unless}}</div>
            {{/each}}
          </details>
        {{/if}}
        {{#if (and @root.showFlowLines this.failureLines.length)}}
          <details class="drep-flow-lines failure drep-collapsible" data-collapse-id="group-{{this.id}}-failure">
            <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Group Failure Lines</span></summary>
            {{#each this.failureLines}}
              <div class="drep-flow-line drep-flow-line-chip" draggable="true" data-drep-line-id="{{this.id}}" data-drep-line-type="failure"><span class="drep-flow-line-text drep-flow-editable" data-edit="line-text" data-line-id="{{this.id}}" data-line-type="failure" data-value="{{this.text}}">{{this.text}}</span>{{#unless @root.readOnly}}<button type="button" class="drep-flow-line-remove" title="Remove">x</button>{{/unless}}</div>
            {{/each}}
          </details>
        {{/if}}
        <div class="drep-flow-checks">
          {{#each this.checks}}
            <div class="drep-flow-check {{#if this.locked}}is-locked{{/if}} {{#if this.groupMaxed}}is-group-maxed{{/if}} {{#if this.complete}}is-complete{{/if}}" data-drep-check-id="{{this.id}}">
              <div class="drep-flow-check-name drep-flow-editable" data-edit="check-name" data-check-id="{{this.id}}" data-value="{{this.rawName}}">{{this.name}}</div>
              <div class="drep-flow-check-meta">
                <span class="drep-flow-check-skill drep-flow-editable" data-edit="check-skill" data-check-id="{{this.id}}" data-skill="{{this.skill}}" data-value="{{this.skill}}">{{this.skillLabel}}</span>
                {{#if (and this.dc (not @root.hideDc))}}
                  <span class="drep-flow-check-dc drep-flow-editable" data-edit="check-dc" data-check-id="{{this.id}}" data-dc="{{this.dc}}">DC {{this.dc}}</span>
                {{/if}}
              </div>
              {{#if this.dependsOnEntries.length}}
                {{#if @root.showFlowRelationships}}
                <div class="drep-flow-deps">
                  <span class="drep-flow-deps-label">Depends on</span>
                  {{#each this.dependsOnEntries}}
                    <span class="drep-flow-dep {{#if (and this.complete (not ../locked) (not ../complete))}}is-complete{{/if}}" data-dep-id="{{this.id}}" data-target-check-id="{{../id}}" data-dep-type="{{this.type}}" title="{{this.detail}}">{{this.label}}{{#unless @root.readOnly}}<button type="button" class="drep-flow-dep-remove" title="Remove">x</button>{{/unless}}</span>
                  {{/each}}
                </div>
              {{/if}}
              {{/if}}
              {{#if (and @root.showFlowLines this.successLines.length)}}
                <details class="drep-flow-lines success drep-collapsible" data-collapse-id="check-{{this.id}}-success">
                  <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Success Lines</span></summary>
                  {{#each this.successLines}}
                    <div class="drep-flow-line drep-flow-line-chip" draggable="true" data-drep-line-id="{{this.id}}" data-drep-line-type="success"><span class="drep-flow-line-text drep-flow-editable" data-edit="line-text" data-line-id="{{this.id}}" data-line-type="success" data-value="{{this.text}}">{{this.text}}</span>{{#unless @root.readOnly}}<button type="button" class="drep-flow-line-remove" title="Remove">x</button>{{/unless}}</div>
                  {{/each}}
                </details>
              {{/if}}
              {{#if (and @root.showFlowLines this.failureLines.length)}}
                <details class="drep-flow-lines failure drep-collapsible" data-collapse-id="check-{{this.id}}-failure">
                  <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Failure Lines</span></summary>
                  {{#each this.failureLines}}
                    <div class="drep-flow-line drep-flow-line-chip" draggable="true" data-drep-line-id="{{this.id}}" data-drep-line-type="failure"><span class="drep-flow-line-text drep-flow-editable" data-edit="line-text" data-line-id="{{this.id}}" data-line-type="failure" data-value="{{this.text}}">{{this.text}}</span>{{#unless @root.readOnly}}<button type="button" class="drep-flow-line-remove" title="Remove">x</button>{{/unless}}</div>
                  {{/each}}
                </details>
              {{/if}}
            </div>
          {{/each}}
          {{#unless this.checks.length}}
            <div class="drep-muted">No checks in this group.</div>
          {{/unless}}
        </div>
      </div>
    {{/each}}
  </div>
</section>
