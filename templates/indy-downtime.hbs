{{#if tab}}
<section class="tab {{tab.cssClass}}" data-tab="{{tab.id}}" data-group="{{tab.group}}">
{{/if}}
  <section class="drep-app {{#if embedded}}embedded{{/if}}" data-drep-root="true" data-drep-tracker="{{trackerId}}">
  <header class="drep-header">
    <div>
      <h1>{{headerLabel}}</h1>
      <div class="drep-subtitle drep-phase-title">{{#if showPhaseNumber}}Phase {{activePhaseNumber}}: {{/if}}{{activePhase.name}}</div>
    </div>
    <div class="drep-status">
      {{#if activePhase.completed}}
        <span class="drep-pill complete">Complete</span>
      {{/if}}
    </div>
  </header>

  <section class="drep-status-row">    
    <div class="section drep-status-grid">
      <div class="drep-progress-block main" style="--progress: {{progressPercent}}">
        <label>Phase Progress</label>
        <div class="drep-value">{{activePhase.progress}} / {{activePhase.target}}</div>
        <div class="drep-progress-bar main">
          <div class="drep-progress-fill" style="--progress: {{progressPercent}}; width: {{progressPercent}}%;"></div>
        </div>
      </div>
      {{#each checkGroups}}
        <div class="drep-progress-block" style="--progress: {{this.percent}}">
          <label>{{this.name}}</label>
          <div class="drep-value">{{this.value}} / {{this.target}}</div>
          <div class="drep-progress-bar">
            <div class="drep-progress-fill" style="--progress: {{this.percent}}; width: {{this.percent}}%;"></div>
          </div>
        </div>
      {{/each}}
      {{#unless checkGroups.length}}
        <div class="drep-muted">No checks configured yet.</div>
      {{/unless}}
    </div>
    {{#if activePhase.image}}
      <div class="drep-phase-art">
        <img src="{{activePhase.image}}" alt="{{activePhase.name}}" />
      </div>
    {{/if}}
  </section>

  <section class="drep-panel">
    <div class="drep-panel-header">
    <h2 class="drep-panel-title">{{intervalLabel}} Check</h2>
    {{#if (or showPhasePlan showEditPlan)}}
      <div class="drep-panel-actions">
        {{#if showPhasePlan}}
          <button type="button" class="drep-button drep-button-secondary" data-drep-action="view-phase-plan">View Phase Plan</button>
        {{/if}}
        {{#if showEditPlan}}
          <button type="button" class="drep-button drep-button-secondary" data-drep-action="edit-phase-plan">Edit Plan</button>
        {{/if}}
      </div>
    {{/if}}
    </div>
    {{#if canRoll}}
      <div class="drep-form">
        <div class="drep-grid">
          {{#if showActorSelect}}
            <label>
              <select data-drep-name="actorId" class="always-interactive">
                <option value="">Select actor</option>
                {{#each actors}}
                  <option value="{{this.id}}" {{#if (eq ../lastActorId this.id)}}selected{{/if}}>{{this.name}}</option>
                {{/each}}
              </select>
            </label>
          {{else}}
            <label>
              <input type="hidden" data-drep-name="actorId" value="{{sheetActor.id}}" class="always-interactive" />
            </label>
          {{/if}}
          <label>
            <select data-drep-name="checkChoice" class="always-interactive">
              {{#each dropdownChoices}}
                <option value="{{this.key}}" {{#if (eq ../lastCheckChoice this.key)}}selected{{/if}} {{#if this.locked}}disabled{{/if}}>
                  {{this.optionLabel}}{{#if this.locked}} (locked){{/if}}
                </option>
              {{/each}}
            </select>
            {{#each checkTitles}}
              <span class="drep-hidden" data-drep-check-title="{{@key}}" data-title="{{this}}"></span>
            {{/each}}
            {{#each checkDescriptions}}
              <span class="drep-hidden" data-drep-check-description="{{@key}}" data-description="{{this}}"></span>
            {{/each}}
            {{#each checkTooltips}}
              <span class="drep-hidden" data-drep-check-tooltip="{{@key}}" data-tooltip="{{this}}"></span>
            {{/each}}
            
          </label>
            <div class="drep-muted drep-check-title">
              <span class="drep-check-title-text">Current Focus: {{selectedCheckLabel}}</span>
              <span class="drep-check-tooltip" title="{{selectedCheckTooltip}}" style="display: {{#if selectedCheckTooltip}}inline-flex{{else}}none{{/if}};">
                <i class="fa-solid fa-circle-info"></i>
              </span>
            </div>
            {{#if selectedCheckDescription}}
              <div class="drep-muted drep-check-description">{{selectedCheckDescription}}</div>
            {{/if}}
          
        <div class="drep-actions">
          <button type="button" data-drep-action="roll-interval" class="always-interactive drep-button drep-button-primary">Roll {{intervalLabel}} Check</button>
        </div>
        </div>
      </div>
    {{else}}
      {{#if activePhase.completed}}
        <div class="drep-muted">This phase is already finished.</div>
      {{else}}
        <div class="drep-muted">No available checks to roll.</div>
      {{/if}}
    {{/if}}
  </section>

  <details class="drep-panel drep-collapsible" open>
    <summary><span class="drep-summary-toggle"><i class="fa-solid fa-angle-down drep-expand"></i><i class="fa-solid fa-angle-up drep-collapse"></i></span><span>Recent Activity</span></summary>
    {{#if state.log.length}}
      <div class="drep-log">
        {{#each state.log}}
          <div class="drep-log-item {{#if this.success}}success{{else}}failure{{/if}}">
            {{#if (eq this.type "phase-complete")}}
              <div class="drep-log-main">
                <strong>Phase Complete:</strong> {{this.phaseName}}
                {{#if this.nextPhaseName}} -> {{this.nextPhaseName}} active{{/if}}
              </div>
            {{else}}
              <div class="drep-log-main">
                <strong>Check {{#if this.checkNumber}}{{this.checkNumber}}{{else}}{{this.windowDay}}{{/if}}:</strong>
                {{this.actorName}} rolled {{#if this.checkName}}{{this.checkName}} ({{this.skillLabel}}){{else}}{{this.skillLabel}}{{/if}}{{#if ../showDc}}{{#if this.dcLabel}} vs {{this.dcLabelType}} {{this.dcLabel}}{{else}} vs DC {{this.dc}}{{/if}}{{/if}}.
              Result: {{#if this.outcomeLabel}}{{this.outcomeLabel}}{{else}}{{this.total}} ({{#if this.success}}Success{{else}}Failure{{/if}}){{/if}}
                {{#if this.progressGained}}
                  | Progress +{{this.progressGained}}{{#if this.criticalBonusApplied}} (critical){{/if}}
                {{/if}}
              </div>
              {{#if this.successLine}}
                <div class="drep-log-note"><strong>Success:</strong> {{this.successLine}}</div>
              {{/if}}
              {{#if this.failureLine}}
                <div class="drep-log-note">
                  <strong>{{#if this.failureEvent}}Event{{else}}Strain{{/if}}:</strong> {{this.failureLine}}
                </div>
              {{/if}}
              {{#if this.failureEventResult}}
                <div class="drep-log-note">
                  <strong>Event Table:</strong> {{this.failureEventResult}}
                </div>
              {{/if}}
            {{/if}}
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="drep-muted">No downtime checks recorded yet.</div>
    {{/if}}
  </details>
  </section>
{{#if tab}}
</section>
{{/if}}
